// Website Builder MVP - Prisma Schema
// Learn more: https://pris.ly/d/prisma-schema

datasource db {
  provider = "postgres"
  url      = env("DATABASE_URL")
  schemas  = ["website_builder"]
}

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

// ============================================
// ENUMS
// ============================================

enum ProjectStatus {
  CREATED
  GBP_SELECTED
  GBP_SCRAPED
  WEBSITE_SCRAPED
  IMAGES_ANALYZED
  HTML_GENERATED
  READY

  @@schema("website_builder")
}

enum PageStatus {
  draft
  published
  inactive

  @@schema("website_builder")
}

// ============================================
// MODELS
// ============================================

/// Represents a single website being built
model Project {
  id                 String        @id @default(uuid())
  userId             String        @map("user_id")
  generatedHostname  String        @unique @map("generated_hostname")
  status             ProjectStatus @default(CREATED)

  // User inputs (from GBP selection)
  selectedPlaceId    String?       @map("selected_place_id")
  selectedWebsiteUrl String?       @map("selected_website_url")

  // Step data columns (populated by n8n workflows)
  stepGbpScrape      Json?         @map("step_gbp_scrape")      // Full GBP data from scrape
  stepWebsiteScrape  Json?         @map("step_website_scrape")  // Full HTML scrape of website
  stepImageAnalysis  Json?         @map("step_image_analysis")  // Array of {s3Url, description}

  createdAt          DateTime      @default(now()) @map("created_at")
  updatedAt          DateTime      @default(now()) @updatedAt @map("updated_at")

  // Relations
  pages Page[]

  @@map("projects")
  @@schema("website_builder")
}

/// Versioned HTML document belonging to a project
model Page {
  id          String     @id @default(uuid())
  projectId   String     @map("project_id")
  path        String     @default("/")
  version     Int        @default(1)
  status      PageStatus @default(draft)
  htmlContent String     @map("html_content") @db.Text
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @default(now()) @updatedAt @map("updated_at")

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([projectId, path])
  @@index([status])
  @@map("pages")
  @@schema("website_builder")
}

/// HTML template with placeholders for generation
model Template {
  id           String   @id @default(uuid())
  name         String
  htmlTemplate String   @map("html_template") @db.Text
  isActive     Boolean  @default(false) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at")

  @@map("templates")
  @@schema("website_builder")
}
